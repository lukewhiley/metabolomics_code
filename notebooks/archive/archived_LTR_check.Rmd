---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r, read in data,  echo = FALSE, results = FALSE, warning=FALSE, message=FALSE, fig.height=6, fig.width=10, }
# libraries
package_list <- c("plyr", "tidyverse", "janitor", "gridExtra", "ggpubr", "readxl", "cowplot", "scales", "devtools", "metabom8", "shiny", "plotly", "svDialogs", "DataEditR", "htmlwidgets")
loaded_packages <- lapply(package_list, require, character.only = TRUE)
rm(loaded_packages)
source('LGW_lipidomics_fuctions.R')

#user input here for project name and user initials
if(exists("project_name") != TRUE){project_name <- dlgInput("what is the name of the project? This must match the string in Filename", "example_project")$res}
if(exists("user_name") != TRUE){user_name <- dlgInput("Insert your initials", "example_initials")$res}

# read in master data
dlg_message("Open metabolite data csv by selecting the CSV generated by the Skyline data processing", type = 'ok')
master_lipid_data <- read_csv(file = file.choose(.))

sampleID <- master_lipid_data %>% select(contains(project_name)) %>% colnames() # create list of sample IDs
lipid <- master_lipid_data$lipid_target # create list of lipid targets
lipid_class_list <- master_lipid_data %>% select(lipid_class) %>% unique()

individual_lipid_data <- master_lipid_data %>% select(contains(project_name)) %>% t() %>% as_tibble(.name_repair = "universal") %>% add_column(sampleID, .before =1)
colnames(individual_lipid_data) <- c("sampleID", lipid)

individual_lipid_data <- individual_lipid_data %>% filter(!grepl("conditioning", sampleID))
class_lipid_data <- create_lipid_class_data_summed(individual_lipid_data)

```

```{r, create plots,  echo = FALSE, warning=FALSE, message=FALSE, fig.height=6, fig.width=10}

#add ltr TRUE/FALSE column

class_lipid_data$is_ltr <- "sample"
class_lipid_data$is_ltr[grep("LTR", class_lipid_data$sampleID)] <- "LTR"

plotlist <- apply(lipid_class_list, 1, function(lipidClass){
  #browser()
  #plot_data <- class_lipid_data %>% select("sampleID", "is_ltr", all_of(lipidClass))
  plot_data <- class_lipid_data %>% select("sampleID", "is_ltr", lipidClass) %>% rename(ms_response = lipid_class)
  plate_id <- str_extract(plot_data$sampleID, "PLIP.*")
  plate_id <- substr(plate_id, 0,15)

  plot_data$sample_index <- paste(plate_id, sub(".*\\_", "", plot_data$sampleID), sep="_")
  plot_data <- plot_data %>% arrange(sample_index)
  plot_data$idx <- 1:nrow(plot_data)
  
  plate_idx <- lapply(unique(plate_id), function(plateID){
  grep(plateID, plot_data$sampleID)[1]
  }) %>% unlist
  
  p <- plot_ly(type = "scatter", plot_data, x = ~idx, y = ~ms_response, text = ~sampleID, color = ~is_ltr, colors = c("red", "lightblue3"), showlegend = FALSE) %>% 
    layout(xaxis = list(title = paste(lipidClass)))
   
    
  plate_number <- unique(plate_id) %>% substr(14,14)
       
  for (idx_line in 2:length(plate_idx)){
    p <- add_trace(p, x = plate_idx[idx_line], type = 'scatter', mode = 'lines', color = paste("plate_", plate_number[idx_line], sep=""), line = list(color = "grey", dash = "dash"), showlegend = FALSE)
  }
  p
})

ltr_check_final_plot <- subplot(plotlist, nrows = 4, titleX = TRUE, margin = c(0.01,0.01,0.05,0.05))

saveWidget(ltr_check_final_plot, file = "ltr_check_final_plot.html")
browseURL("ltr_check_final_plot.html")

```


